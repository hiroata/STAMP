<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>かんたん商品登録 | 切手販売ショップ</title>
        <link rel="icon" type="image/svg+xml" href="icon.svg">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        <link rel="stylesheet" href="css/tailwind-compiled.css?v=20250713-1">
        <style>
            body {
                font-family:
                    'Hiragino Kaku Gothic ProN', 'ヒラギノ角ゴ ProN', 'メイリオ', Meiryo, 'MS Pゴシック', sans-serif;
            }
            .preview-image {
                width: 200px;
                height: 200px;
                object-fit: cover;
                border-radius: 8px;
            }
            /* ドラッグオーバー時のスタイル */
            #drop-zone.drag-over {
                border-color: #3b82f6;
                background-color: #dbeafe;
                transform: scale(1.02);
            }
            /* ドロップゾーンのホバー効果 */
            #drop-zone:hover {
                border-color: #6b7280;
                background-color: #f9fafb;
            }
        </style>
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
        <script src="/firebase-config.js"></script>
        <script src="/js/auth-manager.js"></script>
        <script src="/js/unified-storage.js"></script>
        <script src="/js/image-uploader.js"></script>
        <script src="/js/category-manager.js"></script>
        <script src="/js/backup-manager.js"></script>
        <script src="/js/mobile-detect.js"></script>
    </head>
    <body class="bg-gray-100">
        <script>
            // AuthManagerインスタンス
            let authManager;

            // アクセス制御と初期化は後の方の処理で行うため、ここでは削除

            // ログアウト機能
            async function logout() {
                if (authManager) {
                    await authManager.logout();
                }
                window.location.href = 'admin-login.html';
            }
            
        </script>
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- ナビゲーション -->
            <div class="flex justify-between items-center mb-4">
                <a href="index.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                    ← トップページに戻る
                </a>
                <div class="flex gap-4">
                    <a href="admin-mobile.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline md:hidden">
                        モバイル版 →
                    </a>
                    <a href="admin-enhanced.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                        高度な管理画面 →
                    </a>
                    <button onclick="logout()" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                        ログアウト
                    </button>
                </div>
            </div>
            <!-- タブナビゲーション -->
            <div class="bg-white rounded-t-lg shadow-md mb-0">
                <nav class="flex border-b">
                    <a href="admin.html" class="px-6 py-3 text-[#C41E3A] font-semibold border-b-2 border-[#C41E3A]">
                        商品登録
                    </a>
                    <a href="admin-categories.html" class="px-6 py-3 text-gray-600 hover:text-gray-800 border-b-2 border-transparent hover:border-gray-300">
                        カテゴリー管理
                    </a>
                    <button onclick="showBackupTab()" class="px-6 py-3 text-gray-600 hover:text-gray-800 border-b-2 border-transparent hover:border-gray-300" id="backup-tab">
                        バックアップ
                    </button>
                </nav>
            </div>

            <!-- シンプル商品登録フォーム -->
            <div class="bg-white rounded-b-lg shadow-lg p-4 md:p-8 mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">かんたん商品登録</h1>
                <form id="product-form">
                    <!-- 画像アップロード（大きく目立つ） -->
                    <div class="text-center mb-8">
                        <div
                            id="image-preview"
                            class="mb-4 flex justify-center"
                            ondrop="handleDrop(event)"
                            ondragover="handleDragOver(event)"
                            ondragleave="handleDragLeave(event)"
                        >
                            <div
                                class="w-[200px] h-[200px] border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 transition-all"
                                id="drop-zone"
                            >
                                <p class="text-gray-400">画像をドラッグ&ドロップ<br />または</p>
                            </div>
                        </div>
                        <label
                            for="image"
                            class="cursor-pointer bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors inline-block"
                        >
                            画像を選択
                        </label>
                        <input type="file" id="image" accept="image/*" class="hidden" onchange="window.previewImage(event)" />
                    </div>

                    <!-- 商品名 -->
                    <div class="mb-6">
                        <label class="block text-lg font-medium text-gray-700 mb-2"
                            >商品名 <span class="text-red-500">*</span></label
                        >
                        <input
                            type="text"
                            id="title"
                            required
                            class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="例：日本の風景切手セット"
                        />
                    </div>

                    <!-- 価格と在庫状態 -->
                    <div class="grid grid-cols-1 gap-4 md:gap-6 mb-6">
                        <div>
                            <label class="block text-lg font-medium text-gray-700 mb-2">価格</label>
                            <div class="flex gap-2">
                                <input
                                    type="number"
                                    id="price"
                                    class="flex-1 px-4 py-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="例：1280"
                                />
                                <label class="flex items-center px-4 py-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" id="negotiable" class="mr-2" />
                                    <span class="text-base">応相談</span>
                                </label>
                            </div>
                        </div>
                    </div>


                    <!-- その他の項目 -->
                    <div class="mb-6 space-y-4">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">在庫数</label>
                                <input
                                    type="number"
                                    id="stock"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                    value="1"
                                    min="0"
                                    max="999"
                                />
                                <p class="text-xs text-gray-500 mt-1">※0で在庫切れ表示</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">大カテゴリー</label>
                                <select
                                    id="mainCategory"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                    onchange="updateSubCategories()"
                                >
                                    <option value="">大カテゴリーを選択</option>
                                    <option value="普通切手">普通切手</option>
                                    <option value="航空切手">航空切手</option>
                                    <option value="記念切手">記念切手</option>
                                    <option value="特殊切手">特殊切手</option>
                                    <option value="公園切手">公園切手</option>
                                    <option value="年賀切手">年賀切手</option>
                                    <option value="ふるさと切手">ふるさと切手</option>
                                    <option value="沖縄切手">沖縄切手</option>
                                    <option value="限定販売品">限定販売品</option>
                                    <option value="外国切手">外国切手</option>
                                    <option value="テーマ別切手">テーマ別切手</option>
                                    <option value="エラー・変種切手">エラー・変種切手</option>
                                    <option value="歴史的切手">歴史的切手</option>
                                    <option value="切手関連品">切手関連品</option>
                                    <option value="通信用切手">通信用切手</option>
                                    <option value="収集用品">収集用品</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">サブカテゴリー</label>
                                <select
                                    id="subCategory"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                    disabled
                                >
                                    <option value="">まず大カテゴリーを選択してください</option>
                                </select>
                                <input type="hidden" id="category" value="" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">商品説明</label>
                            <textarea
                                id="description"
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                placeholder="商品の詳細な説明を入力してください"
                            ></textarea>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="isNew" class="mr-2" checked />
                                <span class="text-sm">新着商品として表示</span>
                            </label>
                        </div>
                    </div>

                    <!-- 登録ボタン -->
                    <button
                        type="submit"
                        class="w-full bg-green-600 text-white text-lg font-medium px-6 py-4 rounded-lg hover:bg-green-700 transition-colors mb-4"
                    >
                        商品を登録する
                    </button>

                    <!-- 商品コード（登録ボタンの下） -->
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1"
                            >商品コード（SKU）</label
                        >
                        <input
                            type="text"
                            id="sku"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="例：JP-MJ-001"
                            pattern="[A-Za-z0-9-]+"
                            title="英数字とハイフンのみ使用可能"
                        />
                        <p class="text-xs text-gray-500 mt-1">※未入力の場合は自動生成されます</p>
                    </div>
                </form>
            </div>

            <!-- 登録済み商品一覧 -->
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <h2 class="text-xl font-semibold mb-4">登録済み商品一覧</h2>
                
                <!-- 検索・フィルター機能 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <input
                                type="text"
                                id="searchBox"
                                placeholder="商品名・SKUで検索"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                onkeyup="filterProducts()"
                            />
                        </div>
                        <div>
                            <select id="filterCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="filterProducts()">
                                <option value="">すべてのカテゴリー</option>
                                <option value="普通切手">普通切手</option>
                                <option value="記念切手">記念切手</option>
                                <option value="特殊切手">特殊切手</option>
                                <option value="エラー・変種切手">エラー・変種切手</option>
                                <option value="歴史的切手">歴史的切手</option>
                                <option value="切手関連品">切手関連品</option>
                            </select>
                        </div>
                        <div>
                            <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="filterProducts()">
                                <option value="">すべての状態</option>
                                <option value="active">販売中</option>
                                <option value="soldout">在庫切れ</option>
                                <option value="outofstock">在庫切れ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="products-list" class="space-y-4">
                    <!-- 商品リストがここに表示されます -->
                </div>
            </div>
        </div>

        <script>
            // 統合ストレージマネージャーとImageUploaderを初期化
            let storageManager;
            let imageUploader;
            let categoryManager;
            let backupManager;
            let products = [];
            let filteredProducts = [];
            let editingProductId = null;

            // Firebase初期化を待ってから商品データを取得
            window.addEventListener('DOMContentLoaded', async () => {
                try {
                    // 認証チェック（authManagerが未定義の場合のみ初期化）
                    if (!authManager) {
                        authManager = new AuthManager();
                    }
                    const isAuthenticated = await authManager.requireAuth();
                    
                    if (!isAuthenticated) {
                        // 認証されていない場合はログインページへリダイレクト
                        return;
                    }
                    
                    // Firebaseの状態を確認
                    console.log('Firebase initialized:', typeof firebase !== 'undefined');
                    console.log('Firebase Storage:', typeof firebase?.storage !== 'undefined');
                    console.log('Firebase Database:', typeof firebase?.database !== 'undefined');
                    
                    storageManager = new UnifiedStorageManager();
                    imageUploader = new ImageUploader();
                    categoryManager = new CategoryManager();
                    
                    // バックアップマネージャーを初期化（自動バックアップを開始）
                    backupManager = new BackupManager();
                    
                    // UnifiedStorageManagerの初期化を待つ
                    await new Promise((resolve) => {
                        if (storageManager.isInitialized) {
                            resolve();
                        } else {
                            const checkInterval = setInterval(() => {
                                if (storageManager.isInitialized) {
                                    clearInterval(checkInterval);
                                    resolve();
                                }
                            }, 100);
                        }
                    });
                    
                    // グローバルに公開（デバッグ用）
                    window.imageUploader = imageUploader;
                    
                    // カテゴリー変更を監視
                    categoryManager.onChange(() => {
                        updateCategorySelects();
                    });
                    
                    // カテゴリーセレクトボックスを更新
                    updateCategorySelects();
                    
                    console.log('Storage Manager created:', storageManager);
                    console.log('Image Uploader created:', imageUploader);
                    console.log('Firebase Storage reference:', imageUploader.storage);
                    console.log('Storage bucket:', firebase.app().options.storageBucket);

                    // データ変更を監視
                    storageManager.onDataChange((updatedProducts) => {
                        products = updatedProducts;
                        displayProducts();
                    });
                    
                    // 初期データを読み込む
                    console.log('Loading initial products...');
                    const initialProducts = await storageManager.getProducts();
                    console.log('Initial products loaded:', initialProducts);
                    console.log('Number of products:', initialProducts.length);
                    products = initialProducts;
                    displayProducts();
                } catch (error) {
                    console.error('StorageManager initialization error:', error);
                    alert('初期化エラー: ' + error.message);
                }
            });

            // ドラッグ&ドロップ機能（グローバルスコープに定義）
            window.handleDragOver = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const dropZone = document.getElementById('drop-zone');
                if (dropZone) {
                    dropZone.classList.add('drag-over');
                }
            }

            window.handleDragLeave = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const dropZone = document.getElementById('drop-zone');
                if (dropZone) {
                    dropZone.classList.remove('drag-over');
                }
            }

            window.handleDrop = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const dropZone = document.getElementById('drop-zone');
                if (dropZone) {
                    dropZone.classList.remove('drag-over');
                }

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    // ファイル入力要素に直接ファイルを設定
                    const fileInput = document.getElementById('image');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    fileInput.files = dataTransfer.files;
                    
                    // プレビュー表示
                    const fakeEvent = { target: { files: files } };
                    window.previewImage(fakeEvent);
                }
            }

            // 画像プレビュー機能（グローバルスコープに定義）
            window.previewImage = function(event) {
                console.log('previewImage called');
                const file = event.target.files[0];
                console.log('Selected file:', file);
                
                if (file && file.type.startsWith('image/')) {
                    try {
                        // 基本的な検証
                        if (file.size > 5 * 1024 * 1024) {
                            alert('ファイルサイズが大きすぎます。5MB以下にしてください。');
                            document.getElementById('image').value = '';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            console.log('FileReader loaded');
                            const imagePreview = document.getElementById('image-preview');
                            if (imagePreview) {
                                imagePreview.innerHTML = `
                                    <div class="relative">
                                        <img src="${e.target.result}" class="preview-image w-[200px] h-[200px] object-cover rounded-lg" alt="プレビュー" data-is-new="true">
                                        <button type="button" onclick="window.removeImage()" class="absolute top-2 right-2 bg-red-600 text-white p-2 rounded-full hover:bg-red-700 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                `;
                                console.log('Preview image displayed');
                            }
                        };
                        reader.readAsDataURL(file);
                    } catch (error) {
                        console.error('Preview error:', error);
                        alert(error.message || '画像の読み込みに失敗しました');
                        document.getElementById('image').value = '';
                    }
                } else if (file) {
                    alert('画像ファイルを選択してください（JPEG、PNG、WebP形式）');
                    document.getElementById('image').value = '';
                } else {
                    console.log('No file selected');
                }
            }

            // 画像を削除（グローバルスコープに定義）
            window.removeImage = function() {
                const imageInput = document.getElementById('image');
                const imagePreview = document.getElementById('image-preview');
                
                if (imageInput) {
                    imageInput.value = '';
                }
                
                if (imagePreview) {
                    imagePreview.innerHTML = `
                        <div class="w-[200px] h-[200px] border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 transition-all" id="drop-zone">
                            <p class="text-gray-400">画像をドラッグ&ドロップ<br>または</p>
                        </div>
                    `;
                }
            }

            // 商品フォームの送信処理
            document.getElementById('product-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                // StorageManagerが初期化されているか確認
                if (!storageManager || !imageUploader) {
                    alert('システムが初期化されていません。ページを再読み込みしてください。');
                    return;
                }

                // ボタンを無効化
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = '処理中...';

                try {
                    const priceValue = document.getElementById('price').value;
                    const isNegotiable = document.getElementById('negotiable').checked;

                    const skuValue = document.getElementById('sku').value.trim();
                    const soldOut = false; // 新規登録時は常に販売中
                    const stock = parseInt(document.getElementById('stock').value) || 0;

                    const formData = {
                        id: editingProductId || Date.now().toString(),
                        sku: skuValue || generateSKU(),
                        title: document.getElementById('title').value,
                        price: priceValue ? parseInt(priceValue) : null,
                        priceText: isNegotiable ? '応相談' : (priceValue ? `¥${parseInt(priceValue).toLocaleString()}` : '価格未設定'),
                        negotiable: isNegotiable,
                        category: document.getElementById('category').value || '未分類',
                        description: document.getElementById('description').value || '',
                        stock: stock,
                        isNew: document.getElementById('isNew').checked,
                        soldOut: editingProductId ? (products.find(p => p.id === editingProductId)?.soldOut || false) : false,
                        status: editingProductId ? (products.find(p => p.id === editingProductId)?.status || 'active') : (stock === 0 ? 'outofstock' : 'active'),
                        created_at: editingProductId ?
                            (products.find(p => p.id === editingProductId)?.created_at || new Date().toISOString().split('T')[0]) :
                            new Date().toISOString().split('T')[0],
                        imageUrl: '/images/products/placeholder.jpg'
                    };

                    // 画像処理
                    const imageFile = document.getElementById('image').files[0];
                    const imagePreview = document.querySelector('.preview-image');

                    // 新しい画像がアップロードされた場合
                    if (imageFile && imagePreview && imagePreview.dataset.isNew === 'true') {
                        try {
                            console.log('Starting image upload process...');
                            console.log('Original file:', imageFile.name, imageFile.size, imageFile.type);
                            
                            // 画像をリサイズ
                            const resizedFile = await imageUploader.resizeImage(imageFile);
                            console.log('Resized file:', resizedFile.size);

                            // Firebase Storageにアップロード
                            console.log('Uploading to Firebase Storage...');
                            const uploadResult = await imageUploader.uploadImage(resizedFile, formData.id);
                            console.log('Upload result:', uploadResult);
                            
                            formData.imageUrl = uploadResult.url;
                            formData.imageName = uploadResult.fileName;

                            // 編集モードで古い画像がある場合は削除
                            if (editingProductId) {
                                const oldProduct = products.find(p => p.id === editingProductId);
                                if (oldProduct && oldProduct.imageUrl && oldProduct.imageUrl !== '/images/products/placeholder.jpg') {
                                    await imageUploader.deleteImage(oldProduct.imageUrl);
                                }
                            }
                        } catch (error) {
                            console.error('画像アップロードエラー:', error);
                            if (!confirm('画像のアップロードに失敗しました。画像なしで続行しますか？')) {
                                submitButton.disabled = false;
                                submitButton.textContent = editingProductId ? '商品を更新する' : '商品を登録する';
                                return;
                            }
                        }
                    } else if (imagePreview && !imageFile) {
                        // プレビュー画像がある場合（編集時の既存画像）
                        formData.imageUrl = imagePreview.src;
                    }

                    if (editingProductId) {
                        // 更新モード
                        await storageManager.updateProduct(editingProductId, formData);
                        alert('商品を更新しました！');
                        cancelEdit();
                    } else {
                        // 新規登録モード
                        await storageManager.addProduct(formData);
                        resetForm();
                        alert('商品を登録しました！');
                    }

                    // 登録済み商品一覧にスクロール
                    document.getElementById('products-list').scrollIntoView({ behavior: 'smooth' });

                } catch (error) {
                    console.error('エラー:', error);
                    alert('処理に失敗しました: ' + error.message);
                } finally {
                    // ボタンを有効化
                    submitButton.disabled = false;
                    submitButton.textContent = editingProductId ? '商品を更新する' : '商品を登録する';
                }
            });

            // SKU生成関数
            function generateSKU() {
                const date = new Date();
                const year = date.getFullYear().toString().slice(-2);
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `ST-${year}${month}${day}-${random}`;
            }

            // フォームリセット関数
            function resetForm() {
                document.getElementById('product-form').reset();
                document.getElementById('sku').value = '';
                document.getElementById('stock').value = 1;
                document.getElementById('isNew').checked = true;
                // soldOutチェックボックスは削除された
                document.getElementById('mainCategory').value = '';
                document.getElementById('subCategory').innerHTML = '<option value="">まず大カテゴリーを選択してください</option>';
                document.getElementById('subCategory').disabled = true;
                document.getElementById('category').value = '';
                document.getElementById('image-preview').innerHTML = `
                    <div class="w-[200px] h-[200px] border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50 transition-all" id="drop-zone">
                        <p class="text-gray-400">画像をドラッグ&ドロップ<br>または</p>
                    </div>
                `;
            }

            // 編集をキャンセル
            function cancelEdit() {
                editingProductId = null;
                resetForm();
                document.querySelector('button[type="submit"]').textContent = '商品を登録する';
            }

            // 商品フィルタリング関数
            function filterProducts() {
                const searchText = document.getElementById('searchBox').value.toLowerCase();
                const categoryFilter = document.getElementById('filterCategory').value;
                const statusFilter = document.getElementById('filterStatus').value;

                filteredProducts = products.filter(product => {
                    // テキスト検索
                    const matchesSearch = !searchText || 
                        product.title.toLowerCase().includes(searchText) ||
                        (product.sku && product.sku.toLowerCase().includes(searchText)) ||
                        (product.description && product.description.toLowerCase().includes(searchText));

                    // カテゴリーフィルター
                    const mainCategory = product.category ? product.category.split(' > ')[0] : '';
                    const matchesCategory = !categoryFilter || mainCategory === categoryFilter;

                    // ステータスフィルター
                    const matchesStatus = !statusFilter || product.status === statusFilter;

                    return matchesSearch && matchesCategory && matchesStatus;
                });

                displayFilteredProducts();
            }

            // 商品一覧を表示
            function displayProducts() {
                filteredProducts = products;
                filterProducts();
            }

            // フィルタリングされた商品を表示
            function displayFilteredProducts() {
                const listElement = document.getElementById('products-list');

                if (filteredProducts.length === 0) {
                    listElement.innerHTML = '<p class="text-gray-500">該当する商品はありません</p>';
                    return;
                }

                listElement.innerHTML = filteredProducts.map(product => `
                    <div class="border border-gray-200 rounded-lg p-4 flex flex-col md:flex-row items-start gap-4 ${product.soldOut ? 'bg-gray-50' : ''}">
                        <div class="relative">
                            <img src="${product.imageUrl}" alt="${product.title}" class="w-full md:w-20 h-32 md:h-20 object-cover rounded-lg ${product.soldOut ? 'opacity-60' : ''}">
                            ${product.soldOut ? '<div class="absolute inset-0 flex items-center justify-center"><span class="bg-gray-400 text-white text-xs px-2 py-1 rounded">在庫切れ</span></div>' : ''}
                        </div>
                        <div class="flex-1 w-full">
                            <div class="flex items-start gap-2">
                                <h3 class="font-semibold text-lg ${product.soldOut ? 'text-gray-500' : ''}">${product.title}</h3>
                                ${product.soldOut ? '<span class="text-xs text-gray-500">在庫切れ</span>' : ''}
                            </div>
                            <p class="text-xs text-gray-500 mb-1">SKU: ${product.sku || '未設定'}</p>
                            <p class="text-lg font-bold ${product.negotiable ? 'text-blue-600' : 'text-red-600'} mb-1">
                                ${product.priceText || (product.price ? `¥${product.price.toLocaleString()}` : '価格未設定')}
                            </p>
                            <p class="text-sm text-gray-600">
                                カテゴリー: ${product.category} |
                                在庫: ${product.stock}
                                ${product.isNew && !product.soldOut ? '<span class="ml-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded">NEW</span>' : ''}
                            </p>
                        </div>
                        <div class="flex flex-col gap-2 self-end md:self-start">
                            <div class="flex gap-2">
                                <button onclick="editProduct('${product.id}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-medium">
                                    編集
                                </button>
                                <button onclick="deleteProduct('${product.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-medium">
                                    削除
                                </button>
                            </div>
                            ${!product.soldOut ? `
                                <button onclick="toggleSoldOut('${product.id}')" class="text-xs bg-gray-400 text-white px-3 py-1 rounded hover:bg-gray-500">
                                    在庫切れにする
                                </button>
                            ` : `
                                <button onclick="toggleSoldOut('${product.id}')" class="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">
                                    販売再開
                                </button>
                            `}
                        </div>
                    </div>
                `).join('');
            }

            // 在庫切れ状態を切り替え
            async function toggleSoldOut(id) {
                try {
                    const product = products.find(p => p.id === id);
                    if (!product) return;

                    const newSoldOutStatus = !product.soldOut;
                    const newStatus = newSoldOutStatus ? 'soldout' : 'active';
                    
                    await storageManager.updateProduct(id, {
                        soldOut: newSoldOutStatus,
                        status: newStatus
                    });
                    
                    alert(newSoldOutStatus ? '商品を在庫切れにしました' : '商品を販売再開しました');
                } catch (error) {
                    console.error('Toggle sold out error:', error);
                    alert('ステータスの変更に失敗しました');
                }
            }

            // 商品を削除
            async function deleteProduct(id) {
                if (confirm('この商品を削除しますか？')) {
                    try {
                        // 商品の画像URLを取得
                        const product = products.find(p => p.id === id);

                        // Firebase Storageから画像を削除
                        if (product && product.imageUrl && product.imageUrl !== '/images/products/placeholder.jpg') {
                            await imageUploader.deleteImage(product.imageUrl);
                        }

                        // データベースから商品を削除
                        await storageManager.deleteProduct(id);
                        alert('商品を削除しました');
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert('削除に失敗しました');
                    }
                }
            }


            // 商品を編集
            function editProduct(id) {
                const product = products.find(p => p.id === id);
                if (!product) return;

                editingProductId = id;

                // フォームに値をセット
                document.getElementById('sku').value = product.sku || '';
                document.getElementById('title').value = product.title;
                document.getElementById('price').value = product.price || '';
                document.getElementById('negotiable').checked = product.negotiable;
                // soldOutチェックボックスは削除されたのでコメントアウト
                // document.getElementById('soldOut').checked = product.soldOut || false;

                // カテゴリーの設定
                if (product.category && product.category.includes('-')) {
                    // 新形式（例：error-inverted）
                    const [mainId, subId] = product.category.split('-');
                    if (reverseCategoryMapping[mainId]) {
                        const mainName = reverseCategoryMapping[mainId].name;
                        const subName = reverseCategoryMapping[mainId].subs[subId];
                        
                        document.getElementById('mainCategory').value = mainName;
                        updateSubCategories();
                        // サブカテゴリーの選択を次のフレームで実行
                        setTimeout(() => {
                            document.getElementById('subCategory').value = subName;
                            document.getElementById('category').value = product.category;
                        }, 0);
                    } else {
                        // マッピングがない場合はそのまま使用
                        document.getElementById('mainCategory').value = product.category || '';
                        updateSubCategories();
                        document.getElementById('category').value = product.category || '';
                    }
                } else if (product.category && product.category.includes(' > ')) {
                    // 旧形式（例：エラー・変種切手 > 逆刷りエラー）
                    const [mainCat, subCat] = product.category.split(' > ');
                    document.getElementById('mainCategory').value = mainCat;
                    updateSubCategories();
                    // サブカテゴリーの選択を次のフレームで実行
                    setTimeout(() => {
                        document.getElementById('subCategory').value = subCat;
                        // 新形式に変換して保存
                        if (categoryMapping[mainCat] && categoryMapping[mainCat].subs[subCat]) {
                            const mainId = categoryMapping[mainCat].id;
                            const subId = categoryMapping[mainCat].subs[subCat];
                            document.getElementById('category').value = `${mainId}-${subId}`;
                        } else {
                            document.getElementById('category').value = product.category;
                        }
                    }, 0);
                } else {
                    document.getElementById('mainCategory').value = product.category || '';
                    updateSubCategories();
                    document.getElementById('category').value = product.category || '';
                }

                document.getElementById('description').value = product.description || '';
                document.getElementById('stock').value = product.stock || 1;
                document.getElementById('isNew').checked = product.isNew;

                // 画像プレビューを設定
                if (product.imageUrl && product.imageUrl !== '/images/products/placeholder.jpg') {
                    document.getElementById('image-preview').innerHTML = `
                        <img src="${product.imageUrl}" class="preview-image" data-is-new="false">
                        <div class="text-center mt-2">
                            <button type="button" onclick="removeImage()" class="text-sm text-red-600 hover:text-red-800">
                                画像を削除
                            </button>
                        </div>
                    `;
                }

                // ボタンのテキストを変更
                const submitButton = document.querySelector('#product-form button[type="submit"]');
                submitButton.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    商品を更新する
                `;

                // キャンセルボタンを表示
                if (!document.getElementById('cancel-edit')) {
                    const cancelButton = document.createElement('button');
                    cancelButton.id = 'cancel-edit';
                    cancelButton.type = 'button';
                    cancelButton.className = 'ml-4 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors inline-flex items-center';
                    cancelButton.innerHTML = 'キャンセル';
                    cancelButton.onclick = cancelEdit;
                    submitButton.parentNode.appendChild(cancelButton);
                }

                // フォームまでスクロール
                document.getElementById('product-form').scrollIntoView({ behavior: 'smooth' });
            }

            // カテゴリーセレクトボックスを更新
            function updateCategorySelects() {
                if (!categoryManager) return;
                
                const categoryData = categoryManager.getCategories();
                const mainCategorySelect = document.getElementById('mainCategory');
                const filterCategorySelect = document.getElementById('filterCategory');
                
                // 現在の選択を保存
                const currentMainValue = mainCategorySelect.value;
                const currentFilterValue = filterCategorySelect.value;
                
                // メインカテゴリーセレクトを更新
                mainCategorySelect.innerHTML = '<option value="">大カテゴリーを選択</option>';
                Object.keys(categoryData).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    mainCategorySelect.appendChild(option);
                });
                
                // フィルターカテゴリーセレクトを更新
                filterCategorySelect.innerHTML = '<option value="">すべてのカテゴリー</option>';
                Object.keys(categoryData).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    filterCategorySelect.appendChild(option);
                });
                
                // 選択を復元
                mainCategorySelect.value = currentMainValue;
                filterCategorySelect.value = currentFilterValue;
                
                // サブカテゴリーを更新
                if (currentMainValue) {
                    updateSubCategories();
                }
            }

            // 旧カテゴリーデータ（互換性のため）
            const categoryData = categoryManager ? categoryManager.getCategories() : {
                "普通切手": ["明治普通切手", "手彫切手", "竜文切手", "桜切手", "菊切手", "コイル切手"],
                "航空切手": ["球部航空", "大正航空", "昭和航空（戦前）", "五銭位航空", "円位航空", "銅版航空", "立山航空"],
                "記念切手": ["明治記念", "大正記念", "昭和戦前記念", "昭和戦後記念", "平成記念", "令和記念", "小型シート", "文化人シリーズ", "国体シリーズ", "オリンピック関連"],
                "特殊切手": ["グリーティング切手", "シール式切手", "フレーム切手", "慶弔切手", "弔筒切手", "夏のおたより", "美術切手", "アニメ・ヒーロー"],
                "公園切手": ["第1次国立公園", "第2次国立公園", "国定公園", "富士箱根", "日光", "吉野熊野", "阿蘇", "大山瑠璃"],
                "年賀切手": ["昭和10年以前", "昭和11-20年", "昭和21-30年", "昭和31-40年", "昭和41-50年", "昭和51-64年", "平成年賀", "令和年賀", "お年玉小型シート"],
                "ふるさと切手": ["北海道・東北", "関東・信越", "東海・北陸", "近畿", "中国・四国", "九州・沖縄", "花シリーズ", "風景シリーズ"],
                "沖縄切手": ["米国統治時代", "琉球政府", "暫定切手", "航空切手", "速達切手", "収入印紙"],
                "限定販売品": ["プレミアム切手", "特別販売品", "郵便局限定", "オリジナルフレーム", "年賀パック", "フォルムカード"],
                "外国切手": ["アメリカ", "イギリス", "フランス", "ドイツ", "中国", "韓国", "カナダ", "オーストラリア", "その他の国"],
                "テーマ別切手": ["動物切手", "花・植物切手", "鉄道切手", "芸術・美術切手", "スポーツ切手", "宇宙切手", "船舶切手"],
                "エラー・変種切手": ["逆刷りエラー", "色違いエラー", "目打ちエラー", "印刷ズレ", "定常変種"],
                "歴史的切手": ["手彫切手", "小判切手", "菊切手", "田沢切手", "震災切手"],
                "切手関連品": ["初日カバー", "官製はがき", "収入印紙", "軍事切手"],
                "通信用切手": [],
                "収集用品": ["切手アルバム", "ピンセット", "ルーペ", "マウント", "保存ケース", "カタログ"]
            };

            // カテゴリー名からカテゴリーIDへのマッピング
            const categoryMapping = {
                "エラー・変種切手": {
                    id: "error",
                    subs: {
                        "逆刷りエラー": "inverted",
                        "色違いエラー": "color",
                        "目打ちエラー": "perforation",
                        "印刷ズレ": "misprint",
                        "定常変種": "variant"
                    }
                },
                "歴史的切手": {
                    id: "historical",
                    subs: {
                        "手彫切手": "tebori",
                        "小判切手": "koban",
                        "菊切手": "kiku",
                        "田沢切手": "tazawa",
                        "震災切手": "earthquake"
                    }
                },
                "切手関連品": {
                    id: "related",
                    subs: {
                        "初日カバー": "fdc",
                        "官製はがき": "postcard",
                        "収入印紙": "revenue",
                        "軍事切手": "military"
                    }
                }
            };

            // 逆マッピング（英語IDから日本語名へ）
            const reverseCategoryMapping = {};
            for (const [mainName, mainData] of Object.entries(categoryMapping)) {
                reverseCategoryMapping[mainData.id] = {
                    name: mainName,
                    subs: {}
                };
                for (const [subName, subId] of Object.entries(mainData.subs)) {
                    reverseCategoryMapping[mainData.id].subs[subId] = subName;
                }
            }

            // サブカテゴリー更新関数
            function updateSubCategories() {
                const mainCategory = document.getElementById('mainCategory').value;
                const subCategorySelect = document.getElementById('subCategory');
                const categoryHidden = document.getElementById('category');

                // サブカテゴリーをクリア
                subCategorySelect.innerHTML = '';
                categoryHidden.value = '';

                if (!mainCategory) {
                    subCategorySelect.disabled = true;
                    subCategorySelect.innerHTML = '<option value="">まず大カテゴリーを選択してください</option>';
                    return;
                }

                subCategorySelect.disabled = false;

                if (mainCategory === "通信用切手") {
                    // 通信用切手はサブカテゴリーなし
                    subCategorySelect.innerHTML = '<option value="通信用切手">通信用切手</option>';
                    subCategorySelect.value = "通信用切手";
                    categoryHidden.value = "通信用切手";
                } else {
                    // サブカテゴリーオプションを追加
                    subCategorySelect.innerHTML = '<option value="">サブカテゴリーを選択</option>';

                    const subCategories = categoryManager ? categoryManager.getSubCategories(mainCategory) : [];
                    subCategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subCategorySelect.appendChild(option);
                    });
                }
            }

            // メインカテゴリー変更時の処理
            document.getElementById('mainCategory').addEventListener('change', updateSubCategories);
            
            // サブカテゴリー選択時にhiddenフィールドを更新
            document.getElementById('subCategory').addEventListener('change', function() {
                const mainCategory = document.getElementById('mainCategory').value;
                const subCategory = this.value;
                const categoryHidden = document.getElementById('category');

                if (subCategory) {
                    // カテゴリーマッピングがある場合は、英語IDを使用
                    if (categoryMapping[mainCategory]) {
                        const mainId = categoryMapping[mainCategory].id;
                        const subId = categoryMapping[mainCategory].subs[subCategory];
                        if (subId) {
                            categoryHidden.value = `${mainId}-${subId}`;
                        } else {
                            categoryHidden.value = `${mainCategory} > ${subCategory}`;
                        }
                    } else {
                        categoryHidden.value = `${mainCategory} > ${subCategory}`;
                    }
                } else {
                    categoryHidden.value = '';
                }
            });

            // 初期表示は storageManager の初期化時に自動的に行われる
            
            // バックアップタブを表示
            function showBackupTab() {
                // 既存のタブの非アクティブ化
                document.querySelector('a[href="admin.html"]').classList.remove('text-[#C41E3A]', 'font-semibold', 'border-[#C41E3A]');
                document.querySelector('a[href="admin.html"]').classList.add('text-gray-600', 'border-transparent');
                
                // バックアップタブをアクティブ化
                const backupTab = document.getElementById('backup-tab');
                backupTab.classList.remove('text-gray-600', 'border-transparent');
                backupTab.classList.add('text-[#C41E3A]', 'font-semibold', 'border-[#C41E3A]');
                
                // 商品登録フォームを非表示にしてバックアップ機能を表示
                const productForm = document.querySelector('.bg-white.rounded-b-lg.shadow-lg.p-4');
                productForm.style.display = 'none';
                
                // バックアップセクションを作成して表示
                let backupSection = document.getElementById('backup-section');
                if (!backupSection) {
                    backupSection = document.createElement('div');
                    backupSection.id = 'backup-section';
                    backupSection.className = 'bg-white rounded-b-lg shadow-lg p-4 md:p-8 mb-8';
                    backupSection.innerHTML = `
                        <h1 class="text-2xl font-bold text-gray-800 mb-6">バックアップ管理</h1>
                        <div class="bg-blue-50 rounded-lg p-4 mb-6">
                            <p class="text-sm text-blue-800">
                                商品データの自動バックアップが有効になっています。手動でバックアップを作成することも可能です。
                            </p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">手動バックアップ</h3>
                                <button onclick="createManualBackup()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                    今すぐバックアップを作成
                                </button>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">バックアップ履歴</h3>
                                <div id="backup-history" class="text-sm text-gray-600">
                                    読み込み中...
                                </div>
                            </div>
                        </div>
                    `;
                    productForm.parentNode.insertBefore(backupSection, productForm.nextSibling);
                }
                backupSection.style.display = 'block';
                
                // バックアップ履歴を更新
                if (backupManager) {
                    updateBackupHistory();
                }
            }
            
            // 手動バックアップ作成
            async function createManualBackup() {
                if (!backupManager) {
                    alert('バックアップマネージャーが初期化されていません');
                    return;
                }
                
                try {
                    await backupManager.createManualBackup();
                    alert('バックアップが作成されました');
                    updateBackupHistory();
                } catch (error) {
                    console.error('Manual backup error:', error);
                    alert('バックアップの作成に失敗しました');
                }
            }
            
            // バックアップ履歴を更新
            function updateBackupHistory() {
                const historyDiv = document.getElementById('backup-history');
                if (!historyDiv || !backupManager) return;
                
                // バックアップ履歴の表示
                historyDiv.innerHTML = `
                    <div class="text-sm text-gray-600">
                        <p>自動バックアップ: 有効</p>
                        <p>最後のバックアップ: ${new Date().toLocaleString('ja-JP')}</p>
                    </div>
                `;
            }
        </script>

        <footer class="bg-gray-100 mt-12">
            <div class="container mx-auto px-4 py-8">
                <!-- 配送・送料について -->
                <div class="bg-white rounded-lg p-6 mb-8 border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">配送・送料について</h3>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <h4 class="font-bold text-[#C41E3A] mb-2">郵便局（書留便など）</h4>
                            <p class="text-sm text-gray-600 mb-2">
                                郵便局の書留便、ゆうパックなどでお送りします。お客様の玄関先まで確実にお届けします。
                            </p>
                            <p class="text-sm font-bold text-gray-800">料金は全国一律650円です。</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-[#C41E3A] mb-2">郵便局（特定記録便など）</h4>
                            <p class="text-sm text-gray-600 mb-2">
                                郵便局の特定記録便などでお送りします。基本的にお客様の郵便受箱に配送となります。
                            </p>
                            <p class="text-sm font-bold text-gray-800 mb-2">料金は全国一律400円です。</p>
                            <p class="text-xs text-gray-500">
                                ※特定記録便は万が一、亡失、誤配、商品破損、盗難などがあった場合に補償を受ける事ができません。<br />
                                ※平日のみの配達となります。土日、祝日は配達がありません。
                            </p>
                        </div>
                        <div>
                            <h4 class="font-bold text-[#C41E3A] mb-2">店頭お受け取り</h4>
                            <p class="text-sm text-gray-600 mb-2">
                                ご注文品の用意が整いましたら、メールでお知らせいたしますので、メール受信後に店舗（広島市）にてお受け取りください。
                            </p>
                            <a href="about.html" class="text-sm text-[#C41E3A] hover:underline">店舗案内はこちら »</a>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-8">
                    <div>
                        <h3 class="font-bold text-gray-800 mb-4">
                            <a href="index.html" class="hover:text-[#C41E3A] transition-colors cursor-pointer">ワールドスタンプ広島</a>
                        </h3>
                        <p class="text-sm text-gray-600 mb-2">高品質な切手を適正価格で</p>
                        <p class="text-sm text-gray-600">初心者から愛好家まで幅広くサポート</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 mb-4">ショッピングガイド</h3>
                        <ul class="space-y-2">
                            <li>
                                <a href="order-guide.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                    ご注文方法
                                </a>
                            </li>
                            <li>
                                <a href="payment-guide.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                    お支払い方法
                                </a>
                            </li>
                            <li>
                                <a href="about.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                    店舗案内
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 mb-4">お客様サポート</h3>
                        <ul class="space-y-2">
                            <li>
                                <a href="faq.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                    よくあるご質問
                                </a>
                            </li>
                            <li>
                                <a href="contact.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                    お問い合わせ
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 mb-4">お問い合わせ</h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <svg
                                    class="w-5 h-5"
                                    style="color: #c41e3a"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                                    ></path>
                                </svg>
                                <span class="text-sm text-gray-700 font-medium">082-XXX-XXXX</span>
                            </div>
                            <p class="text-xs text-gray-600 ml-7">
                                平日 9:30-18:00<br />
                                定休日: 月・水・木
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 text-white py-4">
                <div class="container mx-auto px-4 text-center">
                    <p class="text-sm">© 2024 ワールドスタンプ広島 All Rights Reserved.</p>
                    <p class="text-xs mt-2">
                        <a href="admin-login.html" class="text-gray-400 hover:text-gray-300">管理者ログイン</a>
                    </p>
                </div>
            </div>
        </footer>
    </body>
</html>
