<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ | åˆ‡æ‰‹è²©å£²ã‚·ãƒ§ãƒƒãƒ—</title>
        <link rel="icon" type="image/svg+xml" href="icon.svg">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        <link rel="stylesheet" href="css/tailwind-compiled.css?v=20250713-1">
        <style>
            body {
                font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, 'MS Pã‚´ã‚·ãƒƒã‚¯', sans-serif;
            }
            .backup-card {
                transition: all 0.2s ease;
            }
            .backup-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            .loading {
                opacity: 0.6;
                pointer-events: none;
            }
        </style>
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
        <script src="/firebase-config.js"></script>
        <script src="/js/auth-manager.js"></script>
        <script src="/js/simple-backup.js"></script>
    </head>
    <body class="bg-gray-100">
        <script>
            let authManager;
            let backupManager;

            // åˆæœŸåŒ–
            window.addEventListener('DOMContentLoaded', async () => {
                try {
                    authManager = new AuthManager();
                    
                    // èªè¨¼ãƒã‚§ãƒƒã‚¯
                    const isAuthenticated = await authManager.requireAuth();
                    if (!isAuthenticated) {
                        return;
                    }

                    backupManager = new SimpleBackupManager();
                    await initializePage();
                    
                } catch (error) {
                    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    showAlert('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            });

            // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
            async function initializePage() {
                await loadBackupList();
                await updateStats();
                showAlert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†ç”»é¢ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
            }

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            async function logout() {
                if (authManager) {
                    await authManager.logout();
                }
                window.location.href = 'admin-login.html';
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã®èª­ã¿è¾¼ã¿
            async function loadBackupList() {
                try {
                    const container = document.getElementById('backup-list');
                    container.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div><p class="mt-2 text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p></div>';
                    
                    const backups = await backupManager.getBackupList();
                    
                    if (backups.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <div class="text-6xl mb-4">ğŸ“¦</div>
                                <h3 class="text-lg font-medium mb-2">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                                <p class="text-sm">ã€Œä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ãƒœã‚¿ãƒ³ã§æœ€åˆã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = backups.map(backup => `
                        <div class="backup-card bg-white rounded-lg p-6 border border-gray-200">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center mb-3">
                                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                        <h3 class="text-lg font-semibold text-gray-800">${backup.name}</h3>
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <p>ğŸ“… ä½œæˆæ—¥æ™‚: ${backup.created}</p>
                                        <p>ğŸ“¦ å•†å“æ•°: ${backup.productCount}ä»¶</p>
                                        <p>ğŸ’¾ ã‚µã‚¤ã‚º: ${backupManager.formatFileSize(backup.size)}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2 ml-4">
                                    <button onclick="downloadBackup('${backup.id}')" 
                                            class="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                    </button>
                                    <button onclick="restoreBackup('${backup.id}', '${backup.name}')" 
                                            class="px-4 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                                        ğŸ”„ å¾©å…ƒ
                                    </button>
                                    <button onclick="deleteBackup('${backup.id}', '${backup.name}')" 
                                            class="px-4 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                                        ğŸ—‘ï¸ å‰Šé™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('backup-list').innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <p>âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                            <button onclick="loadBackupList()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded text-sm">
                                å†è©¦è¡Œ
                            </button>
                        </div>
                    `;
                }
            }

            // çµ±è¨ˆæƒ…å ±æ›´æ–°
            async function updateStats() {
                try {
                    const stats = await backupManager.getStats();
                    document.getElementById('stats-total').textContent = stats.totalBackups;
                    document.getElementById('stats-size').textContent = stats.totalSize;
                    document.getElementById('stats-latest').textContent = stats.latestBackup;
                } catch (error) {
                    console.error('çµ±è¨ˆæƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
            async function createBackup() {
                try {
                    const button = document.getElementById('create-backup-btn');
                    const originalText = button.textContent;
                    
                    button.disabled = true;
                    button.textContent = 'â³ ä½œæˆä¸­...';
                    
                    const result = await backupManager.quickBackup();
                    
                    if (result.success) {
                        showAlert(`âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†: ${result.name}`, 'success');
                        await loadBackupList();
                        await updateStats();
                    } else {
                        showAlert(`âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå¤±æ•—: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    showAlert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                } finally {
                    const button = document.getElementById('create-backup-btn');
                    button.disabled = false;
                    button.textContent = 'ğŸ“¦ ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—';
                }
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            async function downloadBackup(backupId) {
                try {
                    showAlert('ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...', 'info');
                    const result = await backupManager.downloadBackup(backupId);
                    
                    if (result.success) {
                        showAlert(`âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${result.filename}`, 'success');
                    } else {
                        showAlert(`âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    showAlert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ
            async function restoreBackup(backupId, backupName) {
                try {
                    showAlert('ğŸ”„ å¾©å…ƒä¸­...', 'info');
                    const result = await backupManager.restoreBackup(backupId);
                    
                    if (result.success) {
                        showAlert(`âœ… å¾©å…ƒå®Œäº†: ${result.restoredCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ`, 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else if (result.cancelled) {
                        showAlert('å¾©å…ƒãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'info');
                    } else {
                        showAlert(`âŒ å¾©å…ƒå¤±æ•—: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                    showAlert('å¾©å…ƒä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤
            async function deleteBackup(backupId, backupName) {
                try {
                    const result = await backupManager.deleteBackup(backupId);
                    
                    if (result.success) {
                        showAlert(`âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: ${backupName}`, 'success');
                        await loadBackupList();
                        await updateStats();
                    } else if (result.cancelled) {
                        showAlert('å‰Šé™¤ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'info');
                    } else {
                        showAlert(`âŒ å‰Šé™¤å¤±æ•—: ${result.error}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showAlert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            }

            // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
            function showAlert(message, type = 'info') {
                const alertDiv = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-100 border-green-500 text-green-700' :
                               type === 'error' ? 'bg-red-100 border-red-500 text-red-700' :
                               'bg-blue-100 border-blue-500 text-blue-700';
                
                alertDiv.className = `fixed top-4 right-4 max-w-sm p-4 border-l-4 ${bgColor} rounded shadow-lg z-50`;
                alertDiv.textContent = message;
                
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.remove();
                }, 4000);
            }
        </script>

        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="flex justify-between items-center mb-6">
                <a href="index.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                    â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                </a>
                <div class="flex gap-4">
                    <a href="admin.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">å•†å“ç®¡ç†</a>
                    <a href="admin-categories.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†</a>
                    <button onclick="logout()" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>

            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†</h1>
                <p class="text-gray-600">å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã§ãã¾ã™</p>
            </div>

            <!-- çµ±è¨ˆæƒ…å ± -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-blue-600" id="stats-total">-</div>
                    <div class="text-sm text-gray-600 mt-1">ç·ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•°</div>
                </div>
                <div class="bg-white rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-green-600" id="stats-size">-</div>
                    <div class="text-sm text-gray-600 mt-1">åˆè¨ˆã‚µã‚¤ã‚º</div>
                </div>
                <div class="bg-white rounded-lg p-6 text-center">
                    <div class="text-sm font-medium text-purple-600" id="stats-latest">-</div>
                    <div class="text-sm text-gray-600 mt-1">æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
                </div>
            </div>

            <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ -->
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">ğŸ“¦ æ–°ã—ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ</h2>
                        <p class="text-gray-600">ç¾åœ¨ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼è¨­å®šã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™</p>
                    </div>
                    <button id="create-backup-btn" onclick="createBackup()" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium whitespace-nowrap">
                        ğŸ“¦ ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                    </button>
                </div>
            </div>

            <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="flex justify-between items-center p-6 border-b">
                    <h2 class="text-xl font-semibold text-gray-800">ğŸ“‹ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§</h2>
                    <button onclick="loadBackupList()" class="px-4 py-2 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors">
                        ğŸ”„ æ›´æ–°
                    </button>
                </div>
                <div id="backup-list" class="p-6 space-y-4">
                    <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                </div>
            </div>

            <!-- ä½¿ç”¨æ–¹æ³• -->
            <div class="mt-8 bg-yellow-50 rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸ’¡ ä½¿ç”¨æ–¹æ³•</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-700">
                    <div>
                        <h3 class="font-medium mb-2">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</h3>
                        <ul class="space-y-1">
                            <li>â€¢ é‡è¦ãªä½œæ¥­å‰ã«æ‰‹å‹•ä½œæˆã‚’æ¨å¥¨</li>
                            <li>â€¢ è‡ªå‹•çš„ã«æœ€å¤§10å€‹ã¾ã§ä¿æŒ</li>
                            <li>â€¢ å•†å“ãƒ‡ãƒ¼ã‚¿ã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å«ã‚€</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-medium mb-2">ğŸ”„ å¾©å…ƒã«ã¤ã„ã¦</h3>
                        <ul class="space-y-1">
                            <li>â€¢ å¾©å…ƒå‰ã«è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</li>
                            <li>â€¢ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«ä¸Šæ›¸ã</li>
                            <li>â€¢ å¾©å…ƒå¾Œã¯è‡ªå‹•çš„ã«ãƒšãƒ¼ã‚¸æ›´æ–°</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>