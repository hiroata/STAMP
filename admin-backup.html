<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç† | åˆ‡æ‰‹è²©å£²ã‚·ãƒ§ãƒƒãƒ—</title>
        <link rel="icon" type="image/svg+xml" href="icon.svg">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        <link rel="stylesheet" href="css/tailwind-compiled.css?v=20250713-1">
        <style>
            body {
                font-family:
                    'Hiragino Kaku Gothic ProN', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, 'MS Pã‚´ã‚·ãƒƒã‚¯', sans-serif;
            }
            .backup-item {
                transition: all 0.3s ease;
            }
            .backup-item:hover {
                background-color: #f3f4f6;
            }
            .status-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 8px;
            }
            .status-success { background-color: #10b981; }
            .status-error { background-color: #ef4444; }
            .status-pending { background-color: #f59e0b; }
        </style>
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
        <script src="firebase-config.js"></script>
        <script src="/js/auth-manager.js"></script>
        <script src="/js/backup-manager.js"></script>
    </head>
    <body class="bg-gray-100">
        <script>
            // AuthManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
            let authManager;
            let backupManager;

            // ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¨åˆæœŸåŒ–
            window.addEventListener('DOMContentLoaded', async () => {
                authManager = new AuthManager();

                // èªè¨¼ãƒã‚§ãƒƒã‚¯
                const isAuthenticated = await authManager.requireAuth();
                if (!isAuthenticated) {
                    return; // èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯è‡ªå‹•çš„ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
                }

                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
                backupManager = new BackupManager();
                initializeBackupPage();
            });

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
            async function logout() {
                if (authManager) {
                    await authManager.logout();
                }
                window.location.href = 'admin-login.html';
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–
            async function initializeBackupPage() {
                await loadBackupList();
                updateAutoBackupStatus();
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿
            async function loadBackupList() {
                try {
                    const backupListElement = document.getElementById('backup-list');
                    backupListElement.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div><p class="mt-2 text-gray-600">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div>';

                    // Firebase Realtime Database ã‹ã‚‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã‚’å–å¾—
                    const backups = await backupManager.getBackupList();
                    
                    if (backups.length === 0) {
                        backupListElement.innerHTML = '<div class="text-center py-8 text-gray-500"><p>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</p><p class="text-sm mt-2">ã€Œä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ãƒœã‚¿ãƒ³ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¦ãã ã•ã„</p></div>';
                        return;
                    }

                    backupListElement.innerHTML = backups.map(backup => `
                        <div class="backup-item border rounded-lg p-4 bg-white">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <span class="status-indicator status-${backup.status || 'success'}"></span>
                                        <h3 class="font-semibold text-gray-800">${backup.name || backup.id}</h3>
                                        <span class="ml-2 px-2 py-1 text-xs rounded-full ${backup.type === 'auto' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${backup.type === 'auto' ? 'è‡ªå‹•' : 'æ‰‹å‹•'}</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-1">ä½œæˆæ—¥æ™‚: ${new Date(backup.timestamp).toLocaleString('ja-JP')}</p>
                                    <p class="text-sm text-gray-600 mb-1">å•†å“æ•°: ${backup.productCount || 0}ä»¶</p>
                                    <p class="text-sm text-gray-600">ã‚µã‚¤ã‚º: ${formatFileSize(backup.size || 0)}</p>
                                </div>
                                <div class="flex gap-2 ml-4">
                                    <button onclick="downloadBackup('${backup.id}')" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                        ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                    </button>
                                    <button onclick="restoreBackup('${backup.id}')" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                                        å¾©å…ƒ
                                    </button>
                                    <button onclick="deleteBackup('${backup.id}')" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                                        å‰Šé™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('backup-list').innerHTML = '<div class="text-center py-8 text-red-500"><p>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p><p class="text-sm mt-2">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„</p></div>';
                }
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®è¡¨ç¤ºå½¢å¼å¤‰æ›
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆ
            async function createManualBackup() {
                try {
                    const button = document.getElementById('create-backup-btn');
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆä¸­...';

                    await backupManager.createBackup('manual');
                    
                    showNotification('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ', 'success');
                    await loadBackupList(); // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿

                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                } finally {
                    const button = document.getElementById('create-backup-btn');
                    button.disabled = false;
                    button.textContent = 'ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—';
                }
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            async function downloadBackup(backupId) {
                try {
                    await backupManager.downloadBackup(backupId);
                    showNotification('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
                } catch (error) {
                    console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©å…ƒ
            async function restoreBackup(backupId) {
                if (!confirm('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã™ã‚‹ã¨ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }

                try {
                    await backupManager.restoreBackup(backupId);
                    showNotification('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å¾©å…ƒã•ã‚Œã¾ã—ãŸ', 'success');
                } catch (error) {
                    console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            }

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤
            async function deleteBackup(backupId) {
                if (!confirm('ã“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                    return;
                }

                try {
                    await backupManager.deleteBackup(backupId);
                    showNotification('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ', 'success');
                    await loadBackupList(); // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            }

            // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ…‹ã®æ›´æ–°
            function updateAutoBackupStatus() {
                const lastBackup = localStorage.getItem('lastAutoBackupTime');
                const statusElement = document.getElementById('auto-backup-status');
                
                if (lastBackup) {
                    const lastDate = new Date(lastBackup);
                    statusElement.innerHTML = `æœ€çµ‚è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ${lastDate.toLocaleString('ja-JP')}`;
                } else {
                    statusElement.innerHTML = 'è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: æœªå®Ÿè¡Œ';
                }
            }

            // é€šçŸ¥ã®è¡¨ç¤º
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${
                    type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                    type === 'error' ? 'bg-orange-100 text-red-800 border border-orange-200' :
                    'bg-blue-100 text-blue-800 border border-blue-200'
                }`;
                notification.textContent = message;

                document.body.appendChild(notification);

                // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        </script>

        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="flex justify-between items-center mb-4">
                <a href="index.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                    â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                </a>
                <div class="flex gap-4">
                    <a href="admin.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                        å•†å“ç®¡ç†
                    </a>
                    <a href="admin-enhanced.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                        é«˜åº¦ãªç®¡ç†
                    </a>
                    <button onclick="logout()" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="bg-white rounded-t-lg shadow-md">
                <nav class="flex border-b">
                    <a href="admin.html" class="px-6 py-3 text-gray-600 hover:text-gray-800 border-b-2 border-transparent hover:border-gray-300">
                        å•†å“ç™»éŒ²
                    </a>
                    <a href="admin-categories.html" class="px-6 py-3 text-gray-600 hover:text-gray-800 border-b-2 border-transparent hover:border-gray-300">
                        ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†
                    </a>
                    <a href="admin-backup.html" class="px-6 py-3 text-[#C41E3A] font-semibold border-b-2 border-[#C41E3A]">
                        ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                    </a>
                </nav>
            </div>

            <div class="bg-white rounded-b-lg shadow-lg p-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†</h1>

                <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="bg-blue-50 rounded-lg p-6 mb-8">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆ</h2>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-700 mb-2">å•†å“ãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šã‚’å®‰å…¨ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ãã¾ã™</p>
                            <p class="text-sm text-gray-600" id="auto-backup-status">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ç¢ºèªä¸­...</p>
                        </div>
                        <button 
                            id="create-backup-btn"
                            onclick="createManualBackup()" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                        </button>
                    </div>
                </div>

                <!-- è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š -->
                <div class="bg-green-50 rounded-lg p-6 mb-8">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-700 mb-2">ğŸ“… å®Ÿè¡Œé–“éš”: 24æ™‚é–“ã”ã¨</p>
                            <p class="text-gray-700 mb-2">ğŸ’¾ ä¿æŒæœŸé–“: æœ€å¤§7ä¸–ä»£</p>
                            <p class="text-gray-700">ğŸ”„ çŠ¶æ…‹: æœ‰åŠ¹</p>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <h3 class="font-medium text-gray-800 mb-2">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å†…å®¹</h3>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>â€¢ å…¨å•†å“ãƒ‡ãƒ¼ã‚¿</li>
                                <li>â€¢ ã‚«ãƒ†ã‚´ãƒªãƒ¼è¨­å®š</li>
                                <li>â€¢ ç®¡ç†è€…è¨­å®š</li>
                                <li>â€¢ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§</h2>
                        <button onclick="loadBackupList()" class="px-4 py-2 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors">
                            ğŸ”„ æ›´æ–°
                        </button>
                    </div>
                    <div id="backup-list" class="space-y-4">
                        <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                    </div>
                </div>

                <!-- ä½¿ç”¨æ–¹æ³• -->
                <div class="bg-yellow-50 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“‹ ä½¿ç”¨æ–¹æ³•</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-medium text-gray-800 mb-2">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆ</h3>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>â€¢ ã€Œä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ãƒœã‚¿ãƒ³ã§æ‰‹å‹•ä½œæˆ</li>
                                <li>â€¢ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯24æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ</li>
                                <li>â€¢ æœ€å¤§7ä¸–ä»£ã¾ã§è‡ªå‹•ä¿æŒ</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800 mb-2">å¾©å…ƒã«ã¤ã„ã¦</h3>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>â€¢ å¾©å…ƒå‰ã«å¿…ãšç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</li>
                                <li>â€¢ å¾©å…ƒã«ã‚ˆã‚Šç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™</li>
                                <li>â€¢ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¾©å…ƒã•ã‚Œã¾ã™</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>