<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>å…¨å•†å“ä¸€è¦§ | ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ³ãƒ—åºƒå³¶</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
        <script src="/firebase-config.js"></script>
        <script src="/js/unified-storage.js"></script>
        <link rel="stylesheet" href="css/common.css">
    </head>
    <body>
        <div class="min-h-screen bg-gray-50">
            <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div id="header-container"></div>

            <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
            <nav class="container mx-auto px-4 py-2">
                <ol class="flex text-sm text-gray-600">
                    <li><a href="index.html" class="hover:text-[#C41E3A]">ãƒ›ãƒ¼ãƒ </a></li>
                    <li class="mx-2">/</li>
                    <li class="text-gray-800">å…¨å•†å“ä¸€è¦§</li>
                </ol>
            </nav>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <main class="container mx-auto px-4 py-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">å…¨å•†å“ä¸€è¦§</h2>

                <!-- å•†å“æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="å•†å“ã‚’æ¤œç´¢..."
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C41E3A]"
                        />
                        <select
                            id="categoryFilter"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C41E3A]"
                        >
                            <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
                        </select>
                    </div>
                </div>

                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
                <div id="loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#C41E3A]"></div>
                    <p class="mt-2 text-gray-600">å•†å“ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                </div>

                <!-- å•†å“è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="productsContainer" class="space-y-12 hidden">
                    <!-- å‹•çš„ã«å•†å“ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>

                <!-- å•†å“ãŒãªã„å ´åˆã®è¡¨ç¤º -->
                <div id="noProducts" class="text-center py-8 hidden">
                    <p class="text-gray-600">ç¾åœ¨ã€è¡¨ç¤ºã§ãã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>

                <!-- æ³¨æ–‡æ–¹æ³• -->
                <div class="mt-12 bg-blue-50 border border-blue-200 rounded-lg p-8 text-center">
                    <h3 class="text-xl font-bold mb-4">å•†å“ã®ã”æ³¨æ–‡ã¯ãŠé›»è©±ãƒ»FAXã§</h3>
                    <a href="tel:082-XXX-XXXX" class="text-2xl font-bold text-blue-800 mb-2 phone-number block"
                        >ğŸ“ 082-XXX-XXXX</a
                    >
                    <p class="text-sm">FAX: 082-XXX-XXXX</p>
                    <p class="text-sm mt-2">å–¶æ¥­æ™‚é–“: å¹³æ—¥ 9:30ï½18:00 / å®šä¼‘æ—¥: æœˆãƒ»æ°´ãƒ»æœ¨</p>
                    <p class="mt-4 text-gray-600">â€»ä¾¡æ ¼ã¯å…¨ã¦ç¨è¾¼è¡¨ç¤ºã§ã™</p>
                </div>
            </main>

            <!-- çµ±ä¸€ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <div id="footer-container"></div>
        </div>

        <script>
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
            let storageManager;
            let allProducts = [];
            let filteredProducts = [];

            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
            window.addEventListener('DOMContentLoaded', () => {
                // UnifiedStorageManagerã®åˆæœŸåŒ–
                storageManager = new UnifiedStorageManager();

                // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’ç›£è¦–
                storageManager.onDataChange((products) => {
                    allProducts = products.filter((p) => p.status === 'active');
                    displayProducts();
                });

                // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®è¨­å®š
                setupSearchAndFilter();
            });

            // å•†å“ã‚’è¡¨ç¤º
            function displayProducts() {
                const container = document.getElementById('productsContainer');
                const loading = document.getElementById('loading');
                const noProducts = document.getElementById('noProducts');

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                loading.classList.add('hidden');

                if (filteredProducts.length === 0 && allProducts.length === 0) {
                    container.classList.add('hidden');
                    noProducts.classList.remove('hidden');
                    return;
                }

                // è¡¨ç¤ºã™ã‚‹å•†å“ã‚’æ±ºå®š
                const productsToDisplay = filteredProducts.length > 0 ? filteredProducts : allProducts;

                // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const groupedProducts = {};
                productsToDisplay.forEach((product) => {
                    const mainCategory = product.category ? product.category.split(' > ')[0] : 'æœªåˆ†é¡';
                    if (!groupedProducts[mainCategory]) {
                        groupedProducts[mainCategory] = [];
                    }
                    groupedProducts[mainCategory].push(product);
                });

                // HTMLç”Ÿæˆ
                let html = '';
                Object.entries(groupedProducts).forEach(([category, products]) => {
                    html += `
                    <section>
                        <h3 class="text-2xl font-bold text-[#C41E3A] mb-4">${category}</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                            ${products.map((product) => createProductCard(product)).join('')}
                        </div>
                    </section>
                `;
                });

                container.innerHTML = html;
                container.classList.remove('hidden');
                noProducts.classList.add('hidden');

                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
                updateCategoryFilter();
            }

            // å•†å“ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
            function createProductCard(product) {
                const imageUrl = product.imageUrl || '/images/products/placeholder.jpg';
                const priceDisplay = product.negotiable
                    ? '<span class="text-blue-600">å¿œç›¸è«‡</span>'
                    : product.price
                      ? `Â¥${product.price.toLocaleString()}`
                      : 'ä¾¡æ ¼æœªè¨­å®š';

                return `
                <div class="bg-white rounded-lg shadow p-4 hover:shadow-lg transition-shadow">
                    <div class="relative">
                        <img src="${imageUrl}" alt="${product.title}" 
                             class="w-full h-32 object-cover mb-3 rounded"
                             onerror="this.src='/images/products/placeholder.jpg'">
                        ${product.isNew ? '<span class="absolute top-2 right-2 text-xs bg-red-600 text-white px-2 py-1 rounded">NEW</span>' : ''}
                    </div>
                    <h4 class="font-medium text-sm mb-1">${product.title}</h4>
                    <p class="text-red-600 font-bold">${priceDisplay}</p>
                    ${
                        product.stock && product.stock <= 3
                            ? `<p class="text-xs text-gray-600 mt-1">æ®‹ã‚Š${product.stock}ç‚¹</p>`
                            : ''
                    }
                </div>
            `;
            }

            // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®è¨­å®š
            function setupSearchAndFilter() {
                const searchInput = document.getElementById('searchInput');
                const categoryFilter = document.getElementById('categoryFilter');

                // æ¤œç´¢æ©Ÿèƒ½
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    if (query) {
                        filteredProducts = allProducts.filter(
                            (product) =>
                                product.title.toLowerCase().includes(query) ||
                                (product.description && product.description.toLowerCase().includes(query))
                        );
                    } else {
                        filteredProducts = [];
                    }
                    applyFilters();
                });

                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                categoryFilter.addEventListener('change', (e) => {
                    applyFilters();
                });
            }

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            function applyFilters() {
                const searchQuery = document.getElementById('searchInput').value.toLowerCase();
                const selectedCategory = document.getElementById('categoryFilter').value;

                let products = allProducts;

                // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (searchQuery) {
                    products = products.filter(
                        (product) =>
                            product.title.toLowerCase().includes(searchQuery) ||
                            (product.description && product.description.toLowerCase().includes(searchQuery))
                    );
                }

                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (selectedCategory) {
                    products = products.filter((product) => {
                        const mainCategory = product.category ? product.category.split(' > ')[0] : '';
                        return mainCategory === selectedCategory;
                    });
                }

                filteredProducts = products;
                displayProducts();
            }

            // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
            function updateCategoryFilter() {
                const categoryFilter = document.getElementById('categoryFilter');
                const categories = new Set();

                allProducts.forEach((product) => {
                    const mainCategory = product.category ? product.category.split(' > ')[0] : '';
                    if (mainCategory) {
                        categories.add(mainCategory);
                    }
                });

                // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿å­˜
                const currentValue = categoryFilter.value;

                // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å†æ§‹ç¯‰
                categoryFilter.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>';
                Array.from(categories)
                    .sort()
                    .forEach((category) => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categoryFilter.appendChild(option);
                    });

                // é¸æŠå€¤ã‚’å¾©å…ƒ
                categoryFilter.value = currentValue;
            }
        </script>
        <script src="js/components.js"></script>
    </body>
</html>
