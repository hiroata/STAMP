<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>全商品一覧 | ワールドスタンプ広島</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
        <script src="/firebase-config.js"></script>
        <script src="/js/unified-storage.js"></script>
        <style>
            /* モバイル対応 */
            @media (max-width: 639px) {
                body {
                    font-size: 18px;
                }

                .text-xs {
                    font-size: 14px;
                }

                .text-sm {
                    font-size: 16px;
                }

                .text-base {
                    font-size: 18px;
                }

                .text-lg {
                    font-size: 20px;
                }

                .text-xl {
                    font-size: 22px;
                }

                .text-2xl {
                    font-size: 26px;
                }

                /* タッチフレンドリーボタン */
                a,
                button {
                    min-height: 48px;
                    padding: 12px 16px;
                }

                /* 電話番号をクリック可能に */
                .phone-number {
                    text-decoration: underline;
                    color: #1976d2;
                }
            }
        </style>
    </head>
    <body>
        <div class="min-h-screen bg-gray-50">
            <!-- ヘッダー -->
            <header class="bg-[#B71C1C] text-white p-4">
                <div class="container mx-auto">
                    <h1 class="text-2xl font-bold">
                        <a href="index.html" class="hover:text-gray-300 transition-colors">ワールドスタンプ広島</a>
                    </h1>
                    <p class="text-sm mt-2">ご注文: 📞 082-XXX-XXXX | FAX: 082-XXX-XXXX</p>
                </div>
            </header>

            <!-- パンくずリスト -->
            <nav class="container mx-auto px-4 py-2">
                <ol class="flex text-sm text-gray-600">
                    <li><a href="index.html" class="hover:text-[#C41E3A]">ホーム</a></li>
                    <li class="mx-2">/</li>
                    <li class="text-gray-800">全商品一覧</li>
                </ol>
            </nav>

            <!-- メインコンテンツ -->
            <main class="container mx-auto px-4 py-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">全商品一覧</h2>

                <!-- 商品検索・フィルター -->
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="商品を検索..."
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C41E3A]"
                        />
                        <select
                            id="categoryFilter"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C41E3A]"
                        >
                            <option value="">すべてのカテゴリー</option>
                        </select>
                    </div>
                </div>

                <!-- ローディング表示 -->
                <div id="loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#C41E3A]"></div>
                    <p class="mt-2 text-gray-600">商品を読み込んでいます...</p>
                </div>

                <!-- 商品表示エリア -->
                <div id="productsContainer" class="space-y-12 hidden">
                    <!-- 動的に商品が表示されます -->
                </div>

                <!-- 商品がない場合の表示 -->
                <div id="noProducts" class="text-center py-8 hidden">
                    <p class="text-gray-600">現在、表示できる商品がありません。</p>
                </div>

                <!-- 注文方法 -->
                <div class="mt-12 bg-blue-50 border border-blue-200 rounded-lg p-8 text-center">
                    <h3 class="text-xl font-bold mb-4">商品のご注文はお電話・FAXで</h3>
                    <a href="tel:082-XXX-XXXX" class="text-2xl font-bold text-blue-800 mb-2 phone-number block"
                        >📞 082-XXX-XXXX</a
                    >
                    <p class="text-sm">FAX: 082-XXX-XXXX</p>
                    <p class="text-sm mt-2">営業時間: 平日 9:30～18:00 / 定休日: 月・水・木</p>
                    <p class="mt-4 text-gray-600">※価格は全て税込表示です</p>
                </div>
            </main>

            <!-- フッター -->
            <footer class="bg-gray-100 mt-12">
                <div class="container mx-auto px-4 py-8">
                    <!-- 配送・送料について -->
                    <div class="bg-white rounded-lg p-6 mb-8 border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">配送・送料について</h3>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div>
                                <h4 class="font-bold text-[#C41E3A] mb-2">郵便局（書留便など）</h4>
                                <p class="text-sm text-gray-600 mb-2">
                                    郵便局の書留便、ゆうパックなどでお送りします。お客様の玄関先まで確実にお届けします。
                                </p>
                                <p class="text-sm font-bold text-gray-800">料金は全国一律650円です。</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-[#C41E3A] mb-2">郵便局（特定記録便など）</h4>
                                <p class="text-sm text-gray-600 mb-2">
                                    郵便局の特定記録便などでお送りします。基本的にお客様の郵便受箱に配送となります。
                                </p>
                                <p class="text-sm font-bold text-gray-800 mb-2">料金は全国一律400円です。</p>
                                <p class="text-xs text-gray-500">
                                    ※特定記録便は万が一、亡失、誤配、商品破損、盗難などがあった場合に補償を受ける事ができません。<br />
                                    ※平日のみの配達となります。土日、祝日は配達がありません。
                                </p>
                            </div>
                            <div>
                                <h4 class="font-bold text-[#C41E3A] mb-2">店頭お受け取り</h4>
                                <p class="text-sm text-gray-600 mb-2">
                                    ご注文品の用意が整いましたら、メールでお知らせいたしますので、メール受信後に店舗（広島市）にてお受け取りください。
                                </p>
                                <a href="about.html" class="text-sm text-[#C41E3A] hover:underline"
                                    >店舗案内はこちら »</a
                                >
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-8">
                        <div>
                            <h3 class="font-bold text-gray-800 mb-4">ワールドスタンプ広島</h3>
                            <p class="text-sm text-gray-600 mb-2">高品質な切手を適正価格で</p>
                            <p class="text-sm text-gray-600">初心者から愛好家まで幅広くサポート</p>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 mb-4">ショッピングガイド</h3>
                            <ul class="space-y-2">
                                <li>
                                    <a href="order-guide.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                    ご注文方法
                                    </a>
                                </li>
                                <li>
                                    <a href="payment-guide.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                    お支払い方法
                                    </a>
                                </li>
                                <li>
                                    <a href="about.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                        店舗案内
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 mb-4">お客様サポート</h3>
                            <ul class="space-y-2">
                                <li>
                                    <a href="faq.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                        よくあるご質問
                                    </a>
                                </li>
                                <li>
                                    <a href="contact.html" class="text-sm text-gray-600 hover:text-[#C41E3A] underline">
                                        お問い合わせ
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 mb-4">お問い合わせ</h3>
                            <div class="space-y-3">
                                <div class="flex items-center gap-2">
                                    <svg
                                        class="w-5 h-5"
                                        style="color: #c41e3a"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                                        ></path>
                                    </svg>
                                    <a href="tel:082-XXX-XXXX" class="text-sm text-gray-700 font-medium phone-number"
                                        >082-XXX-XXXX</a
                                    >
                                </div>
                                <p class="text-xs text-gray-600 ml-7">
                                    平日 9:30-18:00<br />
                                    定休日: 月・水・木
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 text-white py-4">
                    <div class="container mx-auto px-4 text-center">
                        <p class="text-sm">© 2024 ワールドスタンプ広島 All Rights Reserved.</p>
                        <p class="text-xs mt-2">
                            <a href="admin-login.html" class="text-gray-400 hover:text-gray-300">管理者ログイン</a>
                        </p>
                    </div>
                </div>
            </footer>
        </div>

        <script>
            // グローバル変数
            let storageManager;
            let allProducts = [];
            let filteredProducts = [];

            // ページ読み込み時の初期化
            window.addEventListener('DOMContentLoaded', () => {
                // UnifiedStorageManagerの初期化
                storageManager = new UnifiedStorageManager();

                // データ変更を監視
                storageManager.onDataChange((products) => {
                    allProducts = products.filter((p) => p.status === 'active');
                    displayProducts();
                });

                // 検索・フィルター機能の設定
                setupSearchAndFilter();
            });

            // 商品を表示
            function displayProducts() {
                const container = document.getElementById('productsContainer');
                const loading = document.getElementById('loading');
                const noProducts = document.getElementById('noProducts');

                // ローディングを非表示
                loading.classList.add('hidden');

                if (filteredProducts.length === 0 && allProducts.length === 0) {
                    container.classList.add('hidden');
                    noProducts.classList.remove('hidden');
                    return;
                }

                // 表示する商品を決定
                const productsToDisplay = filteredProducts.length > 0 ? filteredProducts : allProducts;

                // カテゴリー別にグループ化
                const groupedProducts = {};
                productsToDisplay.forEach((product) => {
                    const mainCategory = product.category ? product.category.split(' > ')[0] : '未分類';
                    if (!groupedProducts[mainCategory]) {
                        groupedProducts[mainCategory] = [];
                    }
                    groupedProducts[mainCategory].push(product);
                });

                // HTML生成
                let html = '';
                Object.entries(groupedProducts).forEach(([category, products]) => {
                    html += `
                    <section>
                        <h3 class="text-2xl font-bold text-[#C41E3A] mb-4">${category}</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                            ${products.map((product) => createProductCard(product)).join('')}
                        </div>
                    </section>
                `;
                });

                container.innerHTML = html;
                container.classList.remove('hidden');
                noProducts.classList.add('hidden');

                // カテゴリーフィルターを更新
                updateCategoryFilter();
            }

            // 商品カードを作成
            function createProductCard(product) {
                const imageUrl = product.imageUrl || '/images/products/placeholder.jpg';
                const priceDisplay = product.negotiable
                    ? '<span class="text-blue-600">応相談</span>'
                    : product.price
                      ? `¥${product.price.toLocaleString()}`
                      : '価格未設定';

                return `
                <div class="bg-white rounded-lg shadow p-4 hover:shadow-lg transition-shadow">
                    <div class="relative">
                        <img src="${imageUrl}" alt="${product.title}" 
                             class="w-full h-32 object-cover mb-3 rounded"
                             onerror="this.src='/images/products/placeholder.jpg'">
                        ${product.isNew ? '<span class="absolute top-2 right-2 text-xs bg-red-600 text-white px-2 py-1 rounded">NEW</span>' : ''}
                    </div>
                    <h4 class="font-medium text-sm mb-1">${product.title}</h4>
                    <p class="text-red-600 font-bold">${priceDisplay}</p>
                    ${
                        product.stock && product.stock <= 3
                            ? `<p class="text-xs text-gray-600 mt-1">残り${product.stock}点</p>`
                            : ''
                    }
                </div>
            `;
            }

            // 検索・フィルター機能の設定
            function setupSearchAndFilter() {
                const searchInput = document.getElementById('searchInput');
                const categoryFilter = document.getElementById('categoryFilter');

                // 検索機能
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    if (query) {
                        filteredProducts = allProducts.filter(
                            (product) =>
                                product.title.toLowerCase().includes(query) ||
                                (product.description && product.description.toLowerCase().includes(query))
                        );
                    } else {
                        filteredProducts = [];
                    }
                    applyFilters();
                });

                // カテゴリーフィルター
                categoryFilter.addEventListener('change', (e) => {
                    applyFilters();
                });
            }

            // フィルターを適用
            function applyFilters() {
                const searchQuery = document.getElementById('searchInput').value.toLowerCase();
                const selectedCategory = document.getElementById('categoryFilter').value;

                let products = allProducts;

                // 検索フィルター
                if (searchQuery) {
                    products = products.filter(
                        (product) =>
                            product.title.toLowerCase().includes(searchQuery) ||
                            (product.description && product.description.toLowerCase().includes(searchQuery))
                    );
                }

                // カテゴリーフィルター
                if (selectedCategory) {
                    products = products.filter((product) => {
                        const mainCategory = product.category ? product.category.split(' > ')[0] : '';
                        return mainCategory === selectedCategory;
                    });
                }

                filteredProducts = products;
                displayProducts();
            }

            // カテゴリーフィルターを更新
            function updateCategoryFilter() {
                const categoryFilter = document.getElementById('categoryFilter');
                const categories = new Set();

                allProducts.forEach((product) => {
                    const mainCategory = product.category ? product.category.split(' > ')[0] : '';
                    if (mainCategory) {
                        categories.add(mainCategory);
                    }
                });

                // 現在の選択値を保存
                const currentValue = categoryFilter.value;

                // オプションを再構築
                categoryFilter.innerHTML = '<option value="">すべてのカテゴリー</option>';
                Array.from(categories)
                    .sort()
                    .forEach((category) => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categoryFilter.appendChild(option);
                    });

                // 選択値を復元
                categoryFilter.value = currentValue;
            }
        </script>
    </body>
</html>
