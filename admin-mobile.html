<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <title>モバイル商品登録 | 切手販売ショップ</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            // Tailwind CDN警告を抑制（開発環境用）
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    corePlugins: {
                        preflight: true,
                    }
                }
            }
        </script>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'ヒラギノ角ゴ ProN', 'メイリオ', Meiryo, sans-serif;
                -webkit-tap-highlight-color: transparent;
                overscroll-behavior: none;
            }
            
            /* カメラ撮影ボタンのスタイル */
            .camera-button {
                position: relative;
                overflow: hidden;
            }
            
            .camera-button input[type="file"] {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                opacity: 0;
                cursor: pointer;
            }
            
            /* 画像プレビューのスタイル */
            .image-preview {
                width: 100%;
                max-height: 60vh;
                object-fit: contain;
                background: #f3f4f6;
            }
            
            /* スワイプ削除のスタイル */
            .swipe-delete {
                transition: transform 0.3s ease;
            }
            
            /* 固定ヘッダー */
            .fixed-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 50;
                background: white;
            }
            
            /* コンテンツのパディング */
            .main-content {
                padding-top: 60px;
                padding-bottom: 80px;
            }
            
            /* 固定フッター */
            .fixed-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 50;
                background: white;
                border-top: 1px solid #e5e7eb;
            }
            
            /* フォーカス時のスタイル改善 */
            input:focus, textarea:focus, select:focus {
                outline: none;
                box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
            }
            
            /* タッチフレンドリーなボタン */
            .touch-button {
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        </style>
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
        <script src="/firebase-config.js"></script>
        <script src="/js/auth-manager.js"></script>
        <script src="/js/unified-storage.js"></script>
        <script src="/js/image-uploader.js"></script>
        <script src="/js/category-manager.js"></script>
    </head>
    <body class="bg-gray-50">
        <script>
            // AuthManagerインスタンス
            let authManager;

            // アクセス制御と初期化
            window.addEventListener('DOMContentLoaded', async () => {
                authManager = new AuthManager();

                // 認証チェック
                const isAuthenticated = await authManager.requireAuth();
                if (!isAuthenticated) {
                    return; // 認証されていない場合は自動的にリダイレクトされる
                }

                // モバイル管理画面の初期化
                initializeMobileAdmin();
            });

            // ログアウト機能
            async function logout() {
                if (authManager) {
                    await authManager.logout();
                }
                window.location.href = 'admin-login.html';
            }
        </script>

        <!-- 固定ヘッダー -->
        <div class="fixed-header shadow-sm">
            <div class="flex items-center justify-between p-4">
                <h1 class="text-lg font-bold text-gray-800">商品登録</h1>
                <button onclick="showMenu()" class="p-2 -mr-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- クイック登録フォーム -->
            <form id="mobile-product-form" class="space-y-4 p-4">
                <!-- 写真撮影/選択エリア -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div id="image-preview-container" class="mb-4">
                        <div id="no-image" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p class="text-gray-500 mb-2">商品の写真を撮影</p>
                        </div>
                        <div id="image-preview" class="hidden">
                            <img id="preview-img" class="image-preview rounded-lg" />
                            <button type="button" onclick="removeImage()" class="mt-2 w-full bg-red-50 text-red-600 py-2 rounded-lg touch-button">
                                写真を削除
                            </button>
                        </div>
                    </div>
                    
                    <div class="camera-button">
                        <button type="button" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium touch-button">
                            <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            写真を撮影 / 選択
                        </button>
                        <input type="file" id="mobile-image" accept="image/*" capture="environment" onchange="handleImageSelect(event)" />
                    </div>
                </div>

                <!-- 商品名（必須） -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        商品名 <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        id="mobile-title"
                        required
                        class="w-full px-3 py-3 text-base border border-gray-300 rounded-lg"
                        placeholder="例：日本の風景切手セット"
                    />
                </div>

                <!-- 価格 -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">価格</label>
                    <div class="flex gap-2">
                        <input
                            type="number"
                            id="mobile-price"
                            inputmode="numeric"
                            pattern="[0-9]*"
                            class="flex-1 px-3 py-3 text-base border border-gray-300 rounded-lg"
                            placeholder="1280"
                        />
                        <button type="button" onclick="toggleNegotiable()" id="negotiable-btn" class="px-4 py-3 border border-gray-300 rounded-lg bg-white">
                            応相談
                        </button>
                    </div>
                    <input type="hidden" id="mobile-negotiable" value="false" />
                </div>

                <!-- カテゴリー（簡易版） -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">カテゴリー</label>
                    <select id="mobile-category" class="w-full px-3 py-3 text-base border border-gray-300 rounded-lg">
                        <option value="">選択してください</option>
                        <option value="普通切手">普通切手</option>
                        <option value="記念切手">記念切手</option>
                        <option value="特殊切手">特殊切手</option>
                        <option value="エラー・変種切手">エラー・変種切手</option>
                        <option value="歴史的切手">歴史的切手</option>
                        <option value="切手関連品">切手関連品</option>
                        <option value="その他">その他</option>
                    </select>
                </div>

                <!-- 在庫数 -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">在庫数</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="decrementStock()" class="px-4 py-3 bg-gray-100 rounded-lg touch-button">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                        </button>
                        <input
                            type="number"
                            id="mobile-stock"
                            value="1"
                            min="0"
                            inputmode="numeric"
                            pattern="[0-9]*"
                            class="flex-1 text-center px-3 py-3 text-lg font-semibold border border-gray-300 rounded-lg"
                        />
                        <button type="button" onclick="incrementStock()" class="px-4 py-3 bg-gray-100 rounded-lg touch-button">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- メモ（任意） -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">メモ（任意）</label>
                    <textarea
                        id="mobile-description"
                        rows="3"
                        class="w-full px-3 py-3 text-base border border-gray-300 rounded-lg"
                        placeholder="商品の詳細など"
                    ></textarea>
                </div>
            </form>

            <!-- 最近登録した商品 -->
            <div class="p-4">
                <h2 class="text-lg font-semibold mb-3">最近登録した商品</h2>
                <div id="recent-products" class="space-y-3">
                    <!-- 商品リストがここに表示されます -->
                </div>
            </div>
        </div>

        <!-- 固定フッター（登録ボタン） -->
        <div class="fixed-footer p-4">
            <button
                type="submit"
                form="mobile-product-form"
                class="w-full bg-green-600 text-white py-4 rounded-lg font-medium text-lg touch-button"
            >
                商品を登録
            </button>
        </div>

        <!-- メニューモーダル -->
        <div id="menu-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden" onclick="hideMenu()">
            <div class="absolute right-0 top-0 h-full w-64 bg-white shadow-lg" onclick="event.stopPropagation()">
                <div class="p-4 border-b">
                    <h2 class="text-lg font-semibold">メニュー</h2>
                </div>
                <nav class="p-4 space-y-3">
                    <a href="admin.html" class="block py-2 text-gray-700">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                        </svg>
                        PC版管理画面
                    </a>
                    <a href="index.html" class="block py-2 text-gray-700">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        トップページ
                    </a>
                    <button onclick="logout()" class="block w-full text-left py-2 text-red-600">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        ログアウト
                    </button>
                </nav>
            </div>
        </div>

        <script>
            let storageManager;
            let imageUploader;
            let categoryManager;
            let selectedFile = null;

            // 初期化
            function initializeMobileAdmin() {
                try {
                    storageManager = new UnifiedStorageManager();
                    imageUploader = new ImageUploader();
                    categoryManager = new CategoryManager();

                    // 最近の商品を表示
                    storageManager.onDataChange((products) => {
                        displayRecentProducts(products);
                    });

                    // カテゴリーを更新
                    updateMobileCategories();

                } catch (error) {
                    console.error('Initialization error:', error);
                    alert('初期化エラー: ' + error.message);
                }
            }

            // フォーム送信処理
            document.getElementById('mobile-product-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = '登録中...';

                try {
                    const title = document.getElementById('mobile-title').value;
                    if (!title) {
                        alert('商品名を入力してください');
                        return;
                    }

                    const priceValue = document.getElementById('mobile-price').value;
                    const isNegotiable = document.getElementById('mobile-negotiable').value === 'true';

                    const formData = {
                        id: Date.now().toString(),
                        sku: generateSKU(),
                        title: title,
                        price: priceValue ? parseInt(priceValue) : null,
                        priceText: isNegotiable ? '応相談' : (priceValue ? `¥${parseInt(priceValue).toLocaleString()}` : '価格未設定'),
                        negotiable: isNegotiable,
                        category: document.getElementById('mobile-category').value || '未分類',
                        description: document.getElementById('mobile-description').value || '',
                        stock: parseInt(document.getElementById('mobile-stock').value) || 1,
                        isNew: true,
                        soldOut: false,
                        status: 'active',
                        created_at: new Date().toISOString(),
                        imageUrl: '/images/products/placeholder.jpg'
                    };

                    // 画像アップロード
                    if (selectedFile) {
                        try {
                            console.log('Uploading image...');
                            const resizedFile = await imageUploader.resizeImage(selectedFile);
                            const uploadResult = await imageUploader.uploadImage(resizedFile, formData.id);
                            formData.imageUrl = uploadResult.url;
                            formData.imageName = uploadResult.fileName;
                        } catch (error) {
                            console.error('Image upload error:', error);
                            if (!confirm('画像のアップロードに失敗しました。画像なしで続行しますか？')) {
                                return;
                            }
                        }
                    }

                    // 商品を登録
                    await storageManager.addProduct(formData);
                    
                    // フォームをリセット
                    resetForm();
                    
                    // 成功メッセージ（振動フィードバック）
                    if (navigator.vibrate) {
                        navigator.vibrate(100);
                    }
                    
                    // 成功通知
                    showSuccessNotification('商品を登録しました！');

                } catch (error) {
                    console.error('Error:', error);
                    alert('登録に失敗しました: ' + error.message);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = '商品を登録';
                }
            });

            // 画像選択処理
            function handleImageSelect(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    selectedFile = file;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('no-image').classList.add('hidden');
                        document.getElementById('image-preview').classList.remove('hidden');
                        document.getElementById('preview-img').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            // 画像削除
            function removeImage() {
                selectedFile = null;
                document.getElementById('mobile-image').value = '';
                document.getElementById('no-image').classList.remove('hidden');
                document.getElementById('image-preview').classList.add('hidden');
            }

            // 応相談トグル
            function toggleNegotiable() {
                const btn = document.getElementById('negotiable-btn');
                const input = document.getElementById('mobile-negotiable');
                const priceInput = document.getElementById('mobile-price');
                
                if (input.value === 'false') {
                    input.value = 'true';
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('bg-white');
                    priceInput.disabled = true;
                    priceInput.value = '';
                } else {
                    input.value = 'false';
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-white');
                    priceInput.disabled = false;
                }
            }

            // 在庫数の増減
            function incrementStock() {
                const input = document.getElementById('mobile-stock');
                input.value = parseInt(input.value) + 1;
            }

            function decrementStock() {
                const input = document.getElementById('mobile-stock');
                const current = parseInt(input.value);
                if (current > 0) {
                    input.value = current - 1;
                }
            }

            // メニュー表示/非表示
            function showMenu() {
                document.getElementById('menu-modal').classList.remove('hidden');
            }

            function hideMenu() {
                document.getElementById('menu-modal').classList.add('hidden');
            }

            // SKU生成
            function generateSKU() {
                const date = new Date();
                const year = date.getFullYear().toString().slice(-2);
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `MB-${year}${month}${day}-${random}`;
            }

            // フォームリセット
            function resetForm() {
                document.getElementById('mobile-product-form').reset();
                removeImage();
                document.getElementById('mobile-stock').value = '1';
                document.getElementById('mobile-negotiable').value = 'false';
                document.getElementById('negotiable-btn').classList.remove('bg-blue-600', 'text-white');
                document.getElementById('negotiable-btn').classList.add('bg-white');
                document.getElementById('mobile-price').disabled = false;
            }

            // 最近の商品を表示
            function displayRecentProducts(products) {
                const container = document.getElementById('recent-products');
                const recentProducts = products
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 5);

                if (recentProducts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">まだ商品がありません</p>';
                    return;
                }

                container.innerHTML = recentProducts.map(product => `
                    <div class="bg-white rounded-lg shadow-sm p-3 flex items-center gap-3">
                        <img src="${product.imageUrl}" alt="${product.title}" class="w-16 h-16 object-cover rounded-lg">
                        <div class="flex-1">
                            <h3 class="font-medium text-sm">${product.title}</h3>
                            <p class="text-sm text-gray-600">${product.priceText}</p>
                            ${product.soldOut ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">SOLD OUT</span>' : ''}
                        </div>
                        <button onclick="toggleProductSoldOut('${product.id}')" class="p-2">
                            ${product.soldOut ? 
                                '<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : 
                                '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                            }
                        </button>
                    </div>
                `).join('');
            }

            // 商品のSOLD OUT切り替え
            async function toggleProductSoldOut(id) {
                try {
                    const products = await storageManager.getProducts();
                    const product = products.find(p => p.id === id);
                    if (!product) return;

                    const newSoldOutStatus = !product.soldOut;
                    await storageManager.updateProduct(id, {
                        soldOut: newSoldOutStatus,
                        status: newSoldOutStatus ? 'soldout' : 'active'
                    });

                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                } catch (error) {
                    console.error('Toggle error:', error);
                }
            }

            // カテゴリー更新
            function updateMobileCategories() {
                if (!categoryManager) return;
                
                const select = document.getElementById('mobile-category');
                const categories = categoryManager.getMainCategories();
                
                select.innerHTML = '<option value="">選択してください</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
            }

            // 成功通知を表示
            function showSuccessNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 left-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 2000);
            }

            // viewport高さの調整（iOS対応）
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }

            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);
            setViewportHeight();
        </script>
    </body>
</html>